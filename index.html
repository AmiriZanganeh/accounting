<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مهراز سیستم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF6B6B;
            --primary-light: #FF8E8E;
            --primary-dark: #FF5252;
            --secondary: #4ECDC4;
            --accent: #FFD166;
            --success: #06D6A0;
            --danger: #EF476F;
            --warning: #FFD166;
            --info: #118AB2;
            --light: #F8F9FA;
            --dark: #212529;
            --darker: #1A1D23;
            --gray: #6C757D;
            --border: #E9ECEF;
            --card-bg: #FFFFFF;
            --sidebar-bg: #2D3047;
            --header-bg: #FFFFFF;
            --bg-gradient: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);
            --sidebar-width: 280px;
            --border-radius: 12px;
            --border-radius-lg: 20px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #F8F9FA 0%, #E9ECEF 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* صفحه ورود */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(78, 205, 196, 0.1) 0%, transparent 50%);
            z-index: -1;
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 50px 40px;
            width: 100%;
            max-width: 480px;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 10px 20px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 107, 107, 0.1);
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 6px;
            background: var(--bg-gradient);
        }

        .brand {
            text-align: center;
            margin-bottom: 40px;
        }

        .brand-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 2.2rem;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .brand-name {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .brand-tagline {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .input-group {
            margin-bottom: 25px;
            position: relative;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px 16px 50px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            background: white;
        }

        .input-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.2rem;
        }

        .login-btn {
            width: 100%;
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn:hover {
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.4);
        }

        .error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 20px;
            font-size: 1rem;
            display: none;
            background: rgba(239, 71, 111, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-right: 3px solid var(--danger);
        }

        /* صفحه اصلی */
        #main-app {
            display: none;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* نوار کناری */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            color: white;
            padding: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-logo-icon {
            width: 50px;
            height: 50px;
            background: var(--bg-gradient);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .app-logo-text {
            font-size: 1.4rem;
            font-weight: 800;
            color: white;
        }

        .sidebar-nav {
            flex: 1;
            padding: 25px 0;
        }

        .nav-item {
            padding: 16px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.05rem;
            margin: 5px 15px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: -1;
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .nav-item.active::before {
            right: 0;
        }

        .nav-item:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-item i {
            width: 24px;
            text-align: center;
            font-size: 1.3rem;
        }

        .user-section {
            padding: 20px 25px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.05);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
        }

        .user-role {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .logout-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            border: none;
            cursor: pointer;
            font-size: 1.3rem;
            padding: 8px;
            border-radius: 8px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* محتوای اصلی */
        .main-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            background: var(--light);
        }

        .content-header {
            background: var(--header-bg);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .page-title {
            font-size: 1.8rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            color: var(--dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .page-description {
            font-size: 1rem;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .content-body {
            padding: 25px 40px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        @media (max-width: 1200px) {
            .content-body {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 6px;
            background: var(--bg-gradient);
        }

        .card:hover {
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-title i {
            color: var(--primary);
            font-size: 1.4rem;
        }

        select, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            color: var(--dark);
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            background: white;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            background: var(--bg-gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #05C78F);
        }

        .btn-success:hover {
            box-shadow: 0 12px 25px rgba(6, 214, 160, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #E83E6D);
        }

        .btn-danger:hover {
            box-shadow: 0 12px 25px rgba(239, 71, 111, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #FFC857);
        }

        .btn-warning:hover {
            box-shadow: 0 12px 25px rgba(255, 209, 102, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #0F7CA3);
        }

        .btn-info:hover {
            box-shadow: 0 12px 25px rgba(17, 138, 178, 0.4);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .transaction-list, .documents-list, .accounts-list, .parties-list {
            max-height: 350px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 15px;
            background: var(--light);
        }

        .transaction-item, .document-item, .account-item, .party-item {
            padding: 14px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .transaction-item:hover, .document-item:hover, .account-item:hover, .party-item:hover {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .transaction-item:last-child, .document-item:last-child, .account-item:last-child, .party-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .transaction-details, .document-details {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .payment {
            color: var(--danger);
        }

        .receipt {
            color: var(--success);
        }

        .document-preview {
            background: var(--light);
            border: 2px solid var(--border);
            padding: 20px;
            border-radius: var(--border-radius);
            min-height: 250px;
            position: relative;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .account-management {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .account-form {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .account-form input {
            flex: 1;
        }

        .document-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 107, 107, 0.05);
            border-radius: var(--border-radius);
            flex-wrap: wrap;
            gap: 15px;
            border: 2px solid var(--border);
        }

        .summary-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .summary-value {
            font-weight: bold;
            font-size: 1.3rem;
            margin-top: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 12px;
            color: #CED4DA;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1rem;
        }

        .hidden {
            display: none;
        }

        /* استایل مبلغ */
        .amount-input-container {
            position: relative;
        }

        .amount-input {
            padding-left: 45px !important;
        }

        .currency-symbol {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* استایل دکمه‌های اسناد */
        .document-actions {
            display: flex;
            gap: 8px;
        }

        .document-action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .document-action-btn.view {
            background: linear-gradient(135deg, var(--success), #05C78F);
            color: white;
        }

        .document-action-btn.delete {
            background: linear-gradient(135deg, var(--danger), #E83E6D);
            color: white;
        }

        .document-action-btn:hover {
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
        }

        .document-action-btn i {
            font-size: 0.85rem;
        }

        /* ریسپانسیو */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
            }

            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 15px;
            }

            .nav-item {
                white-space: nowrap;
                border-bottom: 3px solid transparent;
                padding: 10px 18px;
            }

            .nav-item.active {
                border-bottom: 3px solid var(--primary);
            }

            .main-content {
                padding: 0;
            }

            .content-header {
                padding: 15px;
            }

            .content-body {
                padding: 15px;
                grid-template-columns: 1fr;
            }

            .account-form {
                flex-direction: column;
            }

            .document-summary {
                flex-direction: column;
                gap: 12px;
            }

            .summary-item {
                min-width: 100%;
            }

            .actions {
                flex-direction: column;
            }

            .actions .btn {
                width: 100%;
            }

            .document-actions {
                flex-direction: column;
                width: 100%;
            }

            .document-actions .document-action-btn {
                width: 100%;
            }
            
            /* بهبود نمایش سند حسابداری در موبایل */
            .accounting-table {
                font-size: 0.8rem;
            }
            
            .accounting-table th, 
            .accounting-table td {
                padding: 8px 4px;
            }
            
            .document-description {
                font-size: 0.9rem;
            }
            
            /* بهبود نمایش دفترکل در موبایل */
            .ledger-table-container {
                width: 100%;
                overflow-x: auto;
                border-radius: var(--border-radius);
                border: 1px solid var(--border);
            }
            
            .ledger-table {
                min-width: 100%;
                table-layout: fixed;
            }
            
            .ledger-table th, 
            .ledger-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
                word-break: break-word;
                white-space: normal;
            }
            
            .ledger-table .account-name {
                min-width: 120px;
            }
            
            .ledger-table .date-cell {
                min-width: 90px;
            }
            
            .ledger-table .amount-cell {
                min-width: 80px;
            }
            
            .ledger-table .balance-cell {
                min-width: 100px;
            }
        }

        /* اسکرول بار سفارشی */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F1F1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* استایل‌های جدید برای طراحی خلاق */
        .creative-card {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.2);
            position: relative;
            overflow: hidden;
        }

        .creative-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 6px;
            background: var(--bg-gradient);
        }

        .creative-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30px, -30px);
        }

        .document-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .document-item:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .document-info {
            flex: 1;
        }

        .document-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .document-meta {
            display: flex;
            gap: 12px;
            font-size: 0.85rem;
            color: var(--gray);
        }

        .document-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .document-meta-item i {
            font-size: 0.75rem;
        }

        /* استایل‌های جدید برای فرم‌ها */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            color: var(--dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
            background: white;
        }

        /* استایل‌های جدید برای سند حسابداری */
        .accounting-document {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .document-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .document-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .document-date {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .accounting-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        .accounting-table th {
            background: var(--bg-gradient);
            color: white;
            padding: 12px;
            text-align: right;
            border: 1px solid var(--border);
        }

        .accounting-table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: right;
        }

        /* حذف رنگ‌های بدهکار و بستانکار */
        .debit, .credit {
            font-weight: 600;
        }

        .document-description {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 107, 107, 0.05);
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
        }

        .description-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .description-content {
            color: var(--gray);
            line-height: 1.6;
        }

        /* استایل‌های جدید برای بخش آمار */
        .account-balance {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .account-balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .account-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .account-balance-value {
            font-size: 1.2rem;
            font-weight: 800;
        }

        /* استایل‌های جدید برای بخش آمار به‌روزرسانی شده */
        .account-stat {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-top: 4px solid var(--primary);
        }

        .account-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            margin: 8px 0;
            color: var(--dark);
        }

        .account-stat-label {
            color: var(--gray);
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .account-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* استایل‌های جدید برای لیست طرف‌های حساب در بخش حساب‌ها */
        .parties-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .party-form {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .party-form input, .party-form select {
            flex: 1;
        }

        .parties-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            padding: 15px;
            background: var(--light);
            margin-top: 15px;
        }

        /* استایل‌های جدید برای شرح سند در لیست اسناد */
        .document-description-preview {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--gray);
            line-height: 1.5;
        }
        
        /* بهبود رسپانسیو برای تبلت */
        @media (max-width: 1024px) and (min-width: 769px) {
            .content-body {
                grid-template-columns: 1fr;
                padding: 20px;
            }
            
            .sidebar {
                width: 250px;
            }
            
            .content-header {
                padding: 15px 20px;
            }
        }
        
        /* بهبود رسپانسیو برای موبایل */
        @media (max-width: 480px) {
            .login-card {
                padding: 30px 20px;
            }
            
            .brand-name {
                font-size: 2rem;
            }
            
            .brand-icon {
                width: 60px;
                height: 60px;
                font-size: 1.8rem;
            }
            
            .input-field {
                padding: 14px 16px 14px 45px;
                font-size: 1rem;
            }
            
            .card {
                padding: 20px 15px;
            }
            
            .accounting-table {
                font-size: 0.75rem;
            }
            
            .accounting-table th, 
            .accounting-table td {
                padding: 6px 3px;
            }
            
            .document-description {
                font-size: 0.85rem;
                padding: 10px;
            }
            
            .document-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .document-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            /* بهبود نمایش دفترکل در موبایل */
            .ledger-table-container {
                width: 100%;
                overflow-x: auto;
                border-radius: var(--border-radius);
                border: 1px solid var(--border);
            }
            
            .ledger-table {
                min-width: 100%;
                table-layout: fixed;
            }
            
            .ledger-table th, 
            .ledger-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
                word-break: break-word;
                white-space: normal;
            }
            
            .ledger-table .account-name {
                min-width: 100px;
            }
            
            .ledger-table .date-cell {
                min-width: 80px;
            }
            
            .ledger-table .amount-cell {
                min-width: 70px;
            }
            
            .ledger-table .balance-cell {
                min-width: 90px;
            }
        }
        
        /* بهبود نمایش در حالت لنداسکیپ موبایل */
        @media (max-height: 500px) and (orientation: landscape) {
            .auth-container {
                padding: 10px;
            }
            
            .login-card {
                padding: 20px;
            }
            
            .brand {
                margin-bottom: 20px;
            }
            
            .brand-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
                margin-bottom: 10px;
            }
            
            .brand-name {
                font-size: 1.8rem;
            }
            
            .input-group {
                margin-bottom: 15px;
            }
        }

        /* استایل فوتر */
        .footer {
            text-align: center;
            padding: 20px;
            background: var(--sidebar-bg);
            color: white;
            margin-top: 30px;
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* استایل‌های جدید برای تراز آزمایشی دوستون */
        .trial-balance {
            margin-top: 20px;
        }

        .trial-balance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .trial-balance-table th {
            background: var(--bg-gradient);
            color: white;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .trial-balance-table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .trial-balance-table .account-name {
            text-align: right;
            font-weight: 600;
        }

        /* حذف رنگ‌های قرمز و سبز برای مبالغ */
        .trial-balance-table .debit,
        .trial-balance-table .credit {
            color: var(--dark);
        }

        /* استایل‌های جدید برای دفترکل */
        .ledger-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .ledger-controls select {
            flex: 1;
        }

        .ledger-table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
            table-layout: fixed;
        }

        .ledger-table th {
            background: var(--bg-gradient);
            color: white;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .ledger-table td {
            padding: 10px;
            border: 1px solid var(--border);
            text-align: center;
            word-break: break-word;
            white-space: normal;
        }

        .ledger-table .account-name {
            text-align: right;
            font-weight: 600;
        }

        /* حذف رنگ‌های قرمز و سبز برای مبالغ */
        .ledger-table .debit,
        .ledger-table .credit {
            color: var(--dark);
        }

        .ledger-table .balance {
            font-weight: 700;
        }
        
        /* کلاس‌های جدید برای تنظیم عرض ستون‌ها */
        .ledger-table .date-cell {
            min-width: 100px;
        }
        
        .ledger-table .description-cell {
            min-width: 150px;
        }
        
        .ledger-table .amount-cell {
            min-width: 90px;
        }
        
        .ledger-table .balance-cell {
            min-width: 110px;
        }
    </style>
</head>
<body>
    <!-- صفحه ورود -->
    <div class="auth-container" id="login-page">
        <div class="login-card creative-card">
            <div class="brand">
                <div class="brand-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <h1 class="brand-name">مهراز سیستم</h1>
                <p class="brand-tagline">این سیستم نسخه آزمایشی است</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="input-group">
                    <label for="username" class="input-label">نام کاربری</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="username" class="input-field" placeholder="نام کاربری خود را وارد کنید" required>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="password" class="input-label">رمز عبور</label>
                    <div class="input-with-icon">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="password" class="input-field" placeholder="رمز عبور خود را وارد کنید" required>
                    </div>
                </div>
                
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    ورود به سیستم
                </button>
                
                <div class="error-message" id="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    نام کاربری یا رمز عبور اشتباه است!
                </div>
            </form>
        </div>
    </div>

    <!-- صفحه اصلی سیستم -->
    <div id="main-app">
        <div class="app-layout">
            <!-- نوار کناری -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="app-logo">
                        <div class="app-logo-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="app-logo-text">مهراز سیستم</div>
                    </div>
                </div>
                
                <div class="sidebar-nav">
                    <div class="nav-item active" data-tab="transaction">
                        <i class="fas fa-plus-circle"></i>
                        ثبت
                    </div>
                    <div class="nav-item" data-tab="documents">
                        <i class="fas fa-file-invoice"></i>
                        اسناد
                    </div>
                    <div class="nav-item" data-tab="statistics">
                        <i class="fas fa-chart-bar"></i>
                        آمار
                    </div>
                    <div class="nav-item" data-tab="accounts">
                        <i class="fas fa-wallet"></i>
                        حساب
                    </div>
                </div>
                
                <div class="user-section">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">Amiri</div>
                        <div class="user-role">مدیر سیستم</div>
                    </div>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <!-- محتوای اصلی -->
            <div class="main-content">
                <div class="content-header">
                    <h1 class="page-title" id="page-title">
                        <i class="fas fa-plus-circle"></i>
                        ثبت معامله جدید
                    </h1>
                    <p class="page-description" id="page-description">
                        در این بخش می‌توانید معاملات مالی خود را ثبت و مدیریت کنید
                    </p>
                </div>
                
                <div class="content-body">
                    <div class="card creative-card">
                        <div class="card-header">
                            <h2 class="card-title" id="form-title">
                                <i class="fas fa-edit"></i>
                                فرم ثبت معامله
                            </h2>
                        </div>
                        
                        <div id="transaction-tab" class="tab-content">
                            <form id="transaction-form">
                                <div class="form-group">
                                    <label for="transaction-date" class="form-label">تاریخ معامله</label>
                                    <input type="date" id="transaction-date" class="form-control" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="transaction-type" class="form-label">نوع معامله</label>
                                    <select id="transaction-type" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                        <option value="receipt">دریافت</option>
                                        <option value="payment">پرداخت</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="payment-type" class="form-label">نوع پرداخت</label>
                                    <select id="payment-type" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                        <option value="cash">نقد</option>
                                        <option value="credit">نسیه</option>
                                        <option value="check">چک-سفته</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="account" class="form-label">بابت</label>
                                    <select id="account" class="form-control" required>
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="party" class="form-label">طرف حساب (اختیاری)</label>
                                    <select id="party" class="form-control">
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="amount" class="form-label">مبلغ</label>
                                    <div class="amount-input-container">
                                        <span class="currency-symbol">﷼</span>
                                        <input type="number" id="amount" class="form-control amount-input" placeholder="0" required inputmode="numeric" pattern="[0-9]*">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="description" class="form-label">شرح</label>
                                    <textarea id="description" class="form-control" rows="3" placeholder="شرح معامله" required></textarea>
                                </div>
                                
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-file-alt"></i>
                                    ثبت سند
                                </button>
                            </form>
                        </div>
                        
                        <div id="accounts-tab" class="tab-content hidden">
                            <div class="account-management">
                                <h3>افزودن حساب جدید</h3>
                                <div class="account-form">
                                    <input type="text" id="new-account-name" class="form-control" placeholder="نام حساب جدید">
                                    <button type="button" id="add-account" class="btn btn-success">
                                        <i class="fas fa-plus"></i>
                                        افزودن
                                    </button>
                                </div>
                                
                                <div class="accounts-list" id="accounts-list">
                                    <div class="empty-state">
                                        <i class="fas fa-wallet"></i>
                                        <p>هیچ حسابی ثبت نشده است</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="parties-section">
                                <h3>افزودن طرف حساب جدید</h3>
                                <div class="party-form">
                                    <input type="text" id="new-party-name" class="form-control" placeholder="نام طرف حساب">
                                    <input type="text" id="new-party-type" class="form-control" placeholder="نوع طرف حساب (مشتری/فروشنده)">
                                    <button type="button" id="add-party" class="btn btn-success">
                                        <i class="fas fa-plus"></i>
                                        افزودن
                                    </button>
                                </div>
                                
                                <div class="parties-list" id="parties-list">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <p>هیچ طرف حسابی ثبت نشده است</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="documents-tab" class="tab-content hidden">
                            <div class="documents-list" id="documents-list">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <p>هیچ سندی ذخیره نشده است</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="statistics-tab" class="tab-content hidden">
                            <div class="trial-balance">
                                <h3>تراز آزمایشی دوستون</h3>
                                <table class="trial-balance-table">
                                    <thead>
                                        <tr>
                                            <th>نام حساب</th>
                                            <th>بدهکار</th>
                                            <th>بستانکار</th>
                                        </tr>
                                    </thead>
                                    <tbody id="trial-balance-body">
                                        <tr>
                                            <td colspan="3" class="empty-state">
                                                <i class="fas fa-chart-bar"></i>
                                                <p>هیچ معامله‌ای برای محاسبه تراز آزمایشی وجود ندارد</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="ledger-section" style="margin-top: 30px;">
                                <h3>دفترکل</h3>
                                <div class="ledger-controls">
                                    <select id="ledger-account-select" class="form-control">
                                        <option value="">انتخاب حساب برای مشاهده دفترکل</option>
                                    </select>
                                </div>
                                <div class="ledger-table-container">
                                    <table class="ledger-table">
                                        <thead>
                                            <tr>
                                                <th class="date-cell">تاریخ</th>
                                                <th class="description-cell">شرح</th>
                                                <th class="amount-cell">بدهکار</th>
                                                <th class="amount-cell">بستانکار</th>
                                                <th class="balance-cell">مانده</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ledger-body">
                                            <tr>
                                                <td colspan="5" class="empty-state">
                                                    <i class="fas fa-book"></i>
                                                    <p>لطفاً یک حساب را برای مشاهده دفترکل انتخاب کنید</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card creative-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-file-alt"></i>
                                سند حسابداری
                            </h2>
                        </div>
                        
                        <div class="document-preview" id="document-preview">
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button id="save-document" class="btn btn-success">
                                <i class="fas fa-save"></i>
                                ذخیره سند
                            </button>
                            <button id="clear-document" class="btn btn-info">
                                <i class="fas fa-undo"></i>
                                بازگشت
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- فوتر -->
        <div class="footer">
            طراحی شده توسط <a href="https://amirizanganeh.github.io/accountant/" target="_blank">مهدی امیری</a>
        </div>
    </div>

    <script>
        // اطلاعات ورود
        const VALID_USERNAME = "Amiri";
        const VALID_PASSWORD = "1360";
        
        // نام و نسخه پایگاه داده
        const DB_NAME = 'AuraAccountingDB';
        const DB_VERSION = 1;
        
        // نام جداول
        const STORE_NAMES = {
            ACCOUNTS: 'accounts',
            PARTIES: 'parties',
            TRANSACTIONS: 'transactions',
            DOCUMENTS: 'documents',
            CURRENT_DOCUMENT: 'current_document',
            DOCUMENT_COUNTER: 'document_counter'
        };
        
        // آرایه برای ذخیره معاملات سند جاری
        let currentDocumentTransactions = [];
        
        // آرایه برای ذخیره حساب‌ها
        let accounts = [];
        
        // آرایه برای ذخیره طرف‌های حساب
        let parties = [];
        
        // آرایه برای ذخیره اسناد
        let savedDocuments = [];
        let documentCounter = 1;
        
        // متغیر پایگاه داده
        let db;
        
        // عناصر DOM
        const loginPage = document.getElementById('login-page');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const logoutBtn = document.getElementById('logout-btn');
        const pageTitle = document.getElementById('page-title');
        const pageDescription = document.getElementById('page-description');
        const formTitle = document.getElementById('form-title');
        
        const transactionForm = document.getElementById('transaction-form');
        const documentPreview = document.getElementById('document-preview');
        const saveDocumentBtn = document.getElementById('save-document');
        const clearDocumentBtn = document.getElementById('clear-document');
        const accountSelect = document.getElementById('account');
        const partySelect = document.getElementById('party');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const addAccountBtn = document.getElementById('add-account');
        const newAccountNameInput = document.getElementById('new-account-name');
        const accountsList = document.getElementById('accounts-list');
        const addPartyBtn = document.getElementById('add-party');
        const newPartyNameInput = document.getElementById('new-party-name');
        const newPartyTypeInput = document.getElementById('new-party-type');
        const partiesList = document.getElementById('parties-list');
        const documentsList = document.getElementById('documents-list');
        const trialBalanceBody = document.getElementById('trial-balance-body');
        const ledgerAccountSelect = document.getElementById('ledger-account-select');
        const ledgerBody = document.getElementById('ledger-body');
        const amountInput = document.getElementById('amount');
        
        // مدیریت ورود به سیستم
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === VALID_USERNAME && password === VALID_PASSWORD) {
                // ورود موفق
                loginPage.style.display = 'none';
                mainApp.style.display = 'block';
                initializeApp();
            } else {
                // نمایش خطا
                errorMessage.style.display = 'block';
            }
        });
        
        // مدیریت خروج از سیستم
        logoutBtn.addEventListener('click', function() {
            if (confirm('آیا از خروج از سیستم اطمینان دارید؟')) {
                mainApp.style.display = 'none';
                loginPage.style.display = 'block';
                loginForm.reset();
                errorMessage.style.display = 'none';
            }
        });
        
        // مقداردهی اولیه برنامه پس از ورود
        function initializeApp() {
            // باز کردن پایگاه داده
            openDatabase().then(() => {
                // بارگذاری داده‌ها از IndexedDB
                return Promise.all([
                    loadAccounts(),
                    loadParties(),
                    loadDocuments(),
                    loadDocumentCounter(),
                    loadCurrentDocument()
                ]);
            }).then(() => {
                // تنظیم تاریخ امروز
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('transaction-date').value = today;
                
                // بارگذاری حساب‌ها در dropdown
                updateAccountSelect();
                
                // بارگذاری طرف‌های حساب در dropdown
                updatePartySelect();
                
                // بارگذاری لیست حساب‌ها
                updateAccountsList();
                
                // بارگذاری لیست طرف‌های حساب
                updatePartiesList();
                
                // بارگذاری اسناد ذخیره شده
                updateDocumentsList();
                
                // نمایش سند جاری اگر معامله‌ای وجود دارد
                if (currentDocumentTransactions.length > 0) {
                    generateAccountingDocument();
                }
                
                // رویداد ثبت فرم معامله
                transactionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // دریافت مقادیر از فرم
                    const date = document.getElementById('transaction-date').value;
                    const transactionType = document.getElementById('transaction-type').value;
                    const paymentType = document.getElementById('payment-type').value;
                    const accountId = document.getElementById('account').value;
                    const partyId = document.getElementById('party').value;
                    const amountText = document.getElementById('amount').value;
                    const description = document.getElementById('description').value;
                    
                    // اعتبارسنجی
                    if (!date || !transactionType || !paymentType || !accountId || !amountText || !description) {
                        alert('لطفاً تمام فیلدهای ضروری را پر کنید!');
                        return;
                    }
                    
                    // تبدیل مبلغ به عدد
                    const amount = parseAmount(amountText);
                    
                    if (isNaN(amount) || amount <= 0) {
                        alert('لطفاً یک مبلغ معتبر وارد کنید!');
                        return;
                    }
                    
                    // پیدا کردن نام حساب
                    const account = accounts.find(acc => acc.id == accountId);
                    if (!account) {
                        alert('حساب انتخاب شده معتبر نیست!');
                        return;
                    }
                    
                    // پیدا کردن نام طرف حساب
                    let partyName = '';
                    if (partyId) {
                        const party = parties.find(p => p.id == partyId);
                        partyName = party ? party.name : '';
                    }
                    
                    // ایجاد شیء معامله
                    const transaction = {
                        id: Date.now(),
                        date: formatDate(date),
                        transactionType,
                        paymentType,
                        accountId,
                        accountName: account.name,
                        partyId: partyId || null,
                        partyName: partyName,
                        amount: amount,
                        description
                    };
                    
                    // افزودن به آرایه معاملات سند جاری
                    currentDocumentTransactions.push(transaction);
                    
                    // ذخیره در IndexedDB
                    saveCurrentDocument();
                    
                    // پاک کردن فرم
                    transactionForm.reset();
                    
                    // تنظیم مجدد تاریخ به امروز
                    document.getElementById('transaction-date').value = today;
                    
                    // نمایش پیام موفقیت
                    showNotification('معامله با موفقیت ثبت شد!', 'success');
                    
                    // تولید خودکار سند حسابداری
                    generateAccountingDocument();
                });
                
                // رویداد افزودن حساب جدید
                addAccountBtn.addEventListener('click', function() {
                    const accountName = newAccountNameInput.value.trim();
                    
                    if (!accountName) {
                        showNotification('لطفاً نام حساب را وارد کنید!', 'error');
                        return;
                    }
                    
                    // ایجاد حساب جدید
                    const newAccount = {
                        id: Date.now(),
                        name: accountName
                    };
                    
                    // افزودن به آرایه حساب‌ها
                    accounts.push(newAccount);
                    
                    // ذخیره در IndexedDB
                    saveAccount(newAccount);
                    
                    // به‌روزرسالی dropdown و لیست حساب‌ها
                    updateAccountSelect();
                    updateAccountsList();
                    
                    // پاک کردن فیلد ورودی
                    newAccountNameInput.value = '';
                    
                    // نمایش پیام موفقیت
                    showNotification('حساب جدید با موفقیت افزوده شد!', 'success');
                });
                
                // رویداد افزودن طرف حساب جدید
                addPartyBtn.addEventListener('click', function() {
                    const partyName = newPartyNameInput.value.trim();
                    const partyType = newPartyTypeInput.value.trim();
                    
                    if (!partyName) {
                        showNotification('لطفاً نام طرف حساب را وارد کنید!', 'error');
                        return;
                    }
                    
                    if (!partyType) {
                        showNotification('لطفاً نوع طرف حساب را وارد کنید!', 'error');
                        return;
                    }
                    
                    // ایجاد طرف حساب جدید
                    const newParty = {
                        id: Date.now(),
                        name: partyName,
                        type: partyType
                    };
                    
                    // افزودن به آرایه طرف‌های حساب
                    parties.push(newParty);
                    
                    // ذخیره در IndexedDB
                    saveParty(newParty);
                    
                    // به‌روزرسانی dropdown و لیست طرف‌های حساب
                    updatePartySelect();
                    updatePartiesList();
                    
                    // پاک کردن فیلد ورودی
                    newPartyNameInput.value = '';
                    newPartyTypeInput.value = '';
                    
                    // نمایش پیام موفقیت
                    showNotification('طرف حساب جدید با موفقیت افزوده شد!', 'success');
                });
                
                // رویداد ذخیره سند
                saveDocumentBtn.addEventListener('click', function() {
                    if (currentDocumentTransactions.length === 0) {
                        showNotification('هیچ معامله‌ای برای ذخیره سند وجود ندارد!', 'error');
                        return;
                    }
                    
                    saveAccountingDocument();
                });
                
                // رویداد پاک کردن سند جاری
                clearDocumentBtn.addEventListener('click', function() {
                    if (confirm('آیا از پاک کردن سند جاری اطمینان دارید؟')) {
                        currentDocumentTransactions = [];
                        saveCurrentDocument();
                        documentPreview.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                            </div>
                        `;
                        showNotification('سند جاری با موفقیت پاک شد!', 'success');
                    }
                });
                
                // مدیریت ناوبری
                navItems.forEach(navItem => {
                    navItem.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        
                        // غیرفعال کردن همه آیتم‌های ناوبری
                        navItems.forEach(item => item.classList.remove('active'));
                        tabContents.forEach(content => content.classList.add('hidden'));
                        
                        // فعال کردن آیتم انتخاب شده
                        this.classList.add('active');
                        document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                        
                        // به‌روزرسانی عنوان صفحه
                        updatePageTitle(tabId);
                        
                        // اگر تب آمار انتخاب شده، آمار را به‌روزرسانی کن
                        if (tabId === 'statistics') {
                            updateStatistics();
                        }
                    });
                });
                
                // رویداد تغییر حساب در دفترکل
                ledgerAccountSelect.addEventListener('change', function() {
                    updateLedger(this.value);
                });
                
            }).catch(error => {
                console.error('خطا در مقداردهی اولیه برنامه:', error);
                showNotification('خطا در بارگذاری داده‌ها!', 'error');
            });
        }
        
        // توابع IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    reject(new Error('خطا در باز کردن پایگاه داده'));
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // ایجاد جداول در صورت عدم وجود
                    if (!db.objectStoreNames.contains(STORE_NAMES.ACCOUNTS)) {
                        const accountsStore = db.createObjectStore(STORE_NAMES.ACCOUNTS, { keyPath: 'id' });
                        accountsStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.PARTIES)) {
                        const partiesStore = db.createObjectStore(STORE_NAMES.PARTIES, { keyPath: 'id' });
                        partiesStore.createIndex('name', 'name', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.TRANSACTIONS)) {
                        const transactionsStore = db.createObjectStore(STORE_NAMES.TRANSACTIONS, { keyPath: 'id' });
                        transactionsStore.createIndex('date', 'date', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENTS)) {
                        const documentsStore = db.createObjectStore(STORE_NAMES.DOCUMENTS, { keyPath: 'id' });
                        documentsStore.createIndex('number', 'number', { unique: true });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.CURRENT_DOCUMENT)) {
                        db.createObjectStore(STORE_NAMES.CURRENT_DOCUMENT, { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains(STORE_NAMES.DOCUMENT_COUNTER)) {
                        db.createObjectStore(STORE_NAMES.DOCUMENT_COUNTER, { keyPath: 'id' });
                    }
                };
            });
        }
        
        // بارگذاری حساب‌ها از IndexedDB
        function loadAccounts() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    accounts = request.result;
                    
                    // اگر حساب‌ها خالی هستند، حساب‌های پیش‌فرض را اضافه کن
                    if (accounts.length === 0) {
                        const defaultAccounts = [
                            { id: 1, name: 'موجودی نقد', isSystem: true },
                            { id: 2, name: 'حساب های دریافتنی', isSystem: true },
                            { id: 3, name: 'حساب های پرداختنی', isSystem: true },
                            { id: 4, name: 'اسناد دریافتنی', isSystem: true },
                            { id: 5, name: 'اسناد پرداختنی', isSystem: true },
                            { id: 6, name: 'هزینه', isSystem: false },
                            { id: 7, name: 'درآمد', isSystem: false }
                        ];
                        
                        const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
                        const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
                        
                        defaultAccounts.forEach(account => {
                            store.add(account);
                        });
                        
                        accounts = defaultAccounts;
                    }
                    
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری حساب‌ها'));
                };
            });
        }
        
        // بارگذاری طرف‌های حساب از IndexedDB
        function loadParties() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.PARTIES], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.PARTIES);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    parties = request.result;
                    
                    // اگر طرف‌های حساب خالی هستند، طرف‌های حساب پیش‌فرض را اضافه کن
                    if (parties.length === 0) {
                        const defaultParties = [
                            { id: 1, name: 'امیری', type: 'مشتری' },
                            { id: 2, name: 'امیری', type: 'فروشنده' },
                        ];
                        
                        const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
                        const store = transaction.objectStore(STORE_NAMES.PARTIES);
                        
                        defaultParties.forEach(party => {
                            store.add(party);
                        });
                        
                        parties = defaultParties;
                    }
                    
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری طرف‌های حساب'));
                };
            });
        }
        
        // بارگذاری اسناد از IndexedDB
        function loadDocuments() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    savedDocuments = request.result;
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری اسناد'));
                };
            });
        }
        
        // بارگذاری شمارنده اسناد از IndexedDB
        function loadDocumentCounter() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        documentCounter = request.result.value;
                    } else {
                        // اگر شمارنده وجود ندارد، مقدار پیش‌فرض را تنظیم کن
                        documentCounter = 1;
                        saveDocumentCounter();
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری شمارنده اسناد'));
                };
            });
        }
        
        // بارگذاری سند جاری از IndexedDB
        function loadCurrentDocument() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAMES.CURRENT_DOCUMENT], 'readonly');
                const store = transaction.objectStore(STORE_NAMES.CURRENT_DOCUMENT);
                const request = store.get(1);
                
                request.onsuccess = () => {
                    if (request.result) {
                        currentDocumentTransactions = request.result.transactions || [];
                    } else {
                        currentDocumentTransactions = [];
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    reject(new Error('خطا در بارگذاری سند جاری'));
                };
            });
        }
        
        // ذخیره حساب در IndexedDB
        function saveAccount(account) {
            const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
            store.put(account);
        }
        
        // ذخیره طرف حساب در IndexedDB
        function saveParty(party) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.put(party);
        }
        
        // ذخیره سند در IndexedDB
        function saveDocument(document) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.put(document);
        }
        
        // ذخیره شمارنده اسناد در IndexedDB
        function saveDocumentCounter() {
            const transaction = db.transaction([STORE_NAMES.DOCUMENT_COUNTER], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENT_COUNTER);
            store.put({ id: 1, value: documentCounter });
        }
        
        // ذخیره سند جاری در IndexedDB
        function saveCurrentDocument() {
            const transaction = db.transaction([STORE_NAMES.CURRENT_DOCUMENT], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.CURRENT_DOCUMENT);
            store.put({ id: 1, transactions: currentDocumentTransactions });
        }
        
        // حذف حساب از IndexedDB
        function deleteAccountFromDB(accountId) {
            const transaction = db.transaction([STORE_NAMES.ACCOUNTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.ACCOUNTS);
            store.delete(accountId);
        }
        
        // حذف طرف حساب از IndexedDB
        function deletePartyFromDB(partyId) {
            const transaction = db.transaction([STORE_NAMES.PARTIES], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.PARTIES);
            store.delete(partyId);
        }
        
        // حذف سند از IndexedDB
        function deleteDocumentFromDB(documentId) {
            const transaction = db.transaction([STORE_NAMES.DOCUMENTS], 'readwrite');
            const store = transaction.objectStore(STORE_NAMES.DOCUMENTS);
            store.delete(documentId);
        }
        
        // تابع تبدیل مبلغ به عدد
        function parseAmount(amountText) {
            // حذف کاراکترهای غیرعددی به جز نقطه و کاما
            let cleaned = amountText.replace(/[^\d.,]/g, '');
            
            // اگر کاما به عنوان جداکننده هزارگان استفاده شده، حذف شود
            cleaned = cleaned.replace(/,/g, '');
            
            // تبدیل به عدد
            return parseFloat(cleaned);
        }
        
        // تابع تبدیل تاریخ میلادی به شمسی
        function toPersianDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('fa-IR', options);
        }
        
        // تابع فرمت تاریخ
        function formatDate(dateString) {
            return toPersianDate(dateString);
        }
        
        // تابع تبدیل اعداد به فارسی
        function toPersianNumbers(number) {
            const persianDigits = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            return number.toString().replace(/\d/g, digit => persianDigits[parseInt(digit)]);
        }
        
        // تابع به‌روزرسانی عنوان صفحه
        function updatePageTitle(tabId) {
            const titles = {
                'transaction': {
                    title: 'ثبت معامله جدید',
                    description: 'در این بخش می‌توانید معاملات مالی خود را ثبت و مدیریت کنید',
                    formTitle: 'فرم ثبت معامله'
                },
                'accounts': {
                    title: 'مدیریت حساب‌ها',
                    description: 'در این بخش می‌توانید حساب‌های مالی خود را مدیریت کنید',
                    formTitle: 'لیست حساب‌ها'
                },
                'documents': {
                    title: 'اسناد ذخیره شده',
                    description: 'در این بخش می‌توانید اسناد حسابداری ذخیره شده را مشاهده کنید',
                    formTitle: 'لیست اسناد'
                },
                'statistics': {
                    title: 'آمار و گزارشات',
                    description: 'در این بخش می‌توانید تراز آزمایشی و دفترکل حساب‌ها را مشاهده کنید',
                    formTitle: 'گزارشات مالی'
                }
            };
            
            const titleInfo = titles[tabId];
            pageTitle.innerHTML = `<i class="fas fa-${getTabIcon(tabId)}"></i> ${titleInfo.title}`;
            pageDescription.textContent = titleInfo.description;
            formTitle.innerHTML = `<i class="fas fa-${getTabIcon(tabId)}"></i> ${titleInfo.formTitle}`;
        }
        
        // تابع دریافت آیکون مربوط به تب
        function getTabIcon(tabId) {
            const icons = {
                'transaction': 'edit',
                'accounts': 'wallet',
                'documents': 'file-invoice',
                'statistics': 'chart-bar'
            };
            return icons[tabId];
        }
        
        // تابع دریافت متن نوع پرداخت
        function getPaymentTypeText(paymentType) {
            const types = {
                'cash': 'نقد',
                'credit': 'نسیه',
                'check': 'چک-سفته'
            };
            return types[paymentType] || paymentType;
        }
        
        // تابع به‌روزرسانی dropdown حساب‌ها
        function updateAccountSelect() {
            let html = '<option value="">انتخاب کنید</option>';
            accounts.forEach(account => {
                // فقط حساب‌های غیرسیستمی را نمایش بده
                if (!account.isSystem) {
                    html += `<option value="${account.id}">${account.name}</option>`;
                }
            });
            
            accountSelect.innerHTML = html;
            
            // به‌روزرسانی dropdown حساب‌ها در دفترکل
            let ledgerHtml = '<option value="">انتخاب حساب برای مشاهده دفترکل</option>';
            accounts.forEach(account => {
                ledgerHtml += `<option value="${account.id}">${account.name}</option>`;
            });
            
            ledgerAccountSelect.innerHTML = ledgerHtml;
        }
        
        // تابع به‌روزرسانی dropdown طرف‌های حساب
        function updatePartySelect() {
            let html = '<option value="">انتخاب کنید</option>';
            parties.forEach(party => {
                html += `<option value="${party.id}">${party.name} (${party.type})</option>`;
            });
            
            partySelect.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست حساب‌ها
        function updateAccountsList() {
            // فقط حساب‌های غیرسیستمی را نمایش بده
            const userAccounts = accounts.filter(account => !account.isSystem);
            
            if (userAccounts.length === 0) {
                accountsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-wallet"></i>
                        <p>هیچ حسابی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            userAccounts.forEach(account => {
                html += `
                    <div class="account-item">
                        <span>${account.name}</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount(${account.id})">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                `;
            });
            
            accountsList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست طرف‌های حساب
        function updatePartiesList() {
            if (parties.length === 0) {
                partiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>هیچ طرف حسابی ثبت نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            parties.forEach(party => {
                html += `
                    <div class="party-item">
                        <div>
                            <span>${party.name}</span>
                            <small style="color: var(--success);">(${party.type})</small>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="deleteParty(${party.id})">
                            <i class="fas fa-trash"></i>
                            حذف
                        </button>
                    </div>
                `;
            });
            
            partiesList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی لیست اسناد
        function updateDocumentsList() {
            if (savedDocuments.length === 0) {
                documentsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p>هیچ سندی ذخیره نشده است</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            savedDocuments.forEach(document => {
                // ایجاد شرح از معاملات
                let descriptionText = '';
                document.transactions.forEach(transaction => {
                    descriptionText += `${transaction.description} (${getPaymentTypeText(transaction.paymentType)}) - `;
                });
                
                // حذف آخرین خط تیره از شرح
                if (descriptionText.endsWith(' - ')) {
                    descriptionText = descriptionText.slice(0, -3);
                }
                
                html += `
                    <div class="document-item">
                        <div class="document-info">
                            <div class="document-title">سند شماره ${toPersianNumbers(document.number)}</div>
                            <div class="document-meta">
                                <div class="document-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>${document.date}</span>
                                </div>
                                <div class="document-meta-item">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>${formatCurrency(document.totalAmount)}</span>
                                </div>
                            </div>
                            <div class="document-description-preview">
                                ${descriptionText}
                            </div>
                        </div>
                        <div class="document-actions">
                            <button class="document-action-btn view" onclick="viewDocument(${document.id})">
                                <i class="fas fa-eye"></i>
                                مشاهده
                            </button>
                            <button class="document-action-btn delete" onclick="deleteDocument(${document.id})">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });
            
            documentsList.innerHTML = html;
        }
        
        // تابع به‌روزرسانی آمار
        function updateStatistics() {
            updateTrialBalance();
            updateLedger(ledgerAccountSelect.value);
        }
        
        // تابع به‌روزرسانی تراز آزمایشی
        function updateTrialBalance() {
            if (savedDocuments.length === 0 && currentDocumentTransactions.length === 0) {
                trialBalanceBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>هیچ معامله‌ای برای محاسبه تراز آزمایشی وجود ندارد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // محاسبه مانده هر حساب
            const accountBalances = {};
            
            // مقداردهی اولیه
            accounts.forEach(account => {
                accountBalances[account.id] = {
                    name: account.name,
                    debit: 0,
                    credit: 0
                };
            });
            
            // محاسبه از اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                    
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        // پیدا کردن حساب بدهکار
                        const debitAcc = accounts.find(acc => acc.name === debitAccount);
                        if (debitAcc) {
                            accountBalances[debitAcc.id].debit += transaction.amount;
                        }
                        
                        // حساب انتخاب شده بستانکار می‌شود
                        accountBalances[transaction.accountId].credit += transaction.amount;
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        // حساب انتخاب شده بدهکار می‌شود
                        accountBalances[transaction.accountId].debit += transaction.amount;
                        
                        // پیدا کردن حساب بستانکار
                        const creditAcc = accounts.find(acc => acc.name === creditAccount);
                        if (creditAcc) {
                            accountBalances[creditAcc.id].credit += transaction.amount;
                        }
                    }
                });
            });
            
            // محاسبه از سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                
                if (transaction.transactionType === 'receipt') {
                    // دریافت: حساب انتخاب شده بستانکار می‌شود
                    let debitAccount = '';
                    
                    // تعیین حساب بدهکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            debitAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            debitAccount = 'حساب های دریافتنی';
                            break;
                        case 'check':
                            debitAccount = 'اسناد دریافتنی';
                            break;
                    }
                    
                    // پیدا کردن حساب بدهکار
                    const debitAcc = accounts.find(acc => acc.name === debitAccount);
                    if (debitAcc) {
                        accountBalances[debitAcc.id].debit += transaction.amount;
                    }
                    
                    // حساب انتخاب شده بستانکار می‌شود
                    accountBalances[transaction.accountId].credit += transaction.amount;
                } else if (transaction.transactionType === 'payment') {
                    // پرداخت: حساب انتخاب شده بدهکار می‌شود
                    let creditAccount = '';
                    
                    // تعیین حساب بستانکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            creditAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            creditAccount = 'حساب های پرداختنی';
                            break;
                        case 'check':
                            creditAccount = 'اسناد پرداختنی';
                            break;
                    }
                    
                    // حساب انتخاب شده بدهکار می‌شود
                    accountBalances[transaction.accountId].debit += transaction.amount;
                    
                    // پیدا کردن حساب بستانکار
                    const creditAcc = accounts.find(acc => acc.name === creditAccount);
                    if (creditAcc) {
                        accountBalances[creditAcc.id].credit += transaction.amount;
                    }
                }
            });
            
            let html = '';
            let totalDebit = 0;
            let totalCredit = 0;
            
            // نمایش حساب‌هایی که مانده دارند
            Object.values(accountBalances).forEach(account => {
                if (account.debit > 0 || account.credit > 0) {
                    totalDebit += account.debit;
                    totalCredit += account.credit;
                    
                    html += `
                        <tr>
                            <td class="account-name">${account.name}</td>
                            <td class="debit">${account.debit > 0 ? formatCurrency(account.debit) : '-'}</td>
                            <td class="credit">${account.credit > 0 ? formatCurrency(account.credit) : '-'}</td>
                        </tr>
                    `;
                }
            });
            
            // اضافه کردن ردیف جمع کل
            html += `
                <tr style="background-color: rgba(255, 107, 107, 0.1); font-weight: bold;">
                    <td class="account-name">جمع کل</td>
                    <td class="debit">${formatCurrency(totalDebit)}</td>
                    <td class="credit">${formatCurrency(totalCredit)}</td>
                </tr>
            `;
            
            trialBalanceBody.innerHTML = html;
        }
        
        // تابع به‌روزرسانی دفترکل
        function updateLedger(accountId) {
            if (!accountId) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>لطفاً یک حساب را برای مشاهده دفترکل انتخاب کنید</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const account = accounts.find(acc => acc.id == accountId);
            if (!account) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>حساب انتخاب شده معتبر نیست</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // جمع‌آوری تمام معاملات مربوط به این حساب
            const ledgerEntries = [];
            let balance = 0;
            
            // بررسی اسناد ذخیره شده
            savedDocuments.forEach(document => {
                document.transactions.forEach(transaction => {
                    // بررسی معاملات مربوط به حساب انتخاب شده
                    if (transaction.accountId == accountId) {
                        let debit = 0;
                        let credit = 0;
                        
                        if (transaction.transactionType === 'receipt') {
                            credit = transaction.amount;
                            balance -= transaction.amount;
                        } else if (transaction.transactionType === 'payment') {
                            debit = transaction.amount;
                            balance += transaction.amount;
                        }
                        
                        ledgerEntries.push({
                            date: document.date,
                            description: transaction.description,
                            debit: debit,
                            credit: credit,
                            balance: balance
                        });
                    }
                    
                    // بررسی معاملات مربوط به حساب‌های مرتبط
                    let relatedAccount = '';
                    if (transaction.transactionType === 'receipt') {
                        // دریافت: حساب انتخاب شده بستانکار می‌شود
                        let debitAccount = '';
                        
                        // تعیین حساب بدهکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                debitAccount = 'موجودی نقد';
                                break;
                            case 'credit':
                                debitAccount = 'حساب های دریافتنی';
                                break;
                            case 'check':
                                debitAccount = 'اسناد دریافتنی';
                                break;
                        }
                        
                        if (debitAccount === account.name) {
                            debit = transaction.amount;
                            credit = 0;
                            balance += transaction.amount;
                            
                            ledgerEntries.push({
                                date: document.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    } else if (transaction.transactionType === 'payment') {
                        // پرداخت: حساب انتخاب شده بدهکار می‌شود
                        let creditAccount = '';
                        
                        // تعیین حساب بستانکار بر اساس نوع پرداخت
                        switch(transaction.paymentType) {
                            case 'cash':
                                creditAccount = 'موجودی نقد';
                                break;
                            case 'credit':
                                creditAccount = 'حساب های پرداختنی';
                                break;
                            case 'check':
                                creditAccount = 'اسناد پرداختنی';
                                break;
                        }
                        
                        if (creditAccount === account.name) {
                            debit = 0;
                            credit = transaction.amount;
                            balance -= transaction.amount;
                            
                            ledgerEntries.push({
                                date: document.date,
                                description: transaction.description,
                                debit: debit,
                                credit: credit,
                                balance: balance
                            });
                        }
                    }
                });
            });
            
            // بررسی سند جاری
            currentDocumentTransactions.forEach(transaction => {
                // بررسی معاملات مربوط به حساب انتخاب شده
                if (transaction.accountId == accountId) {
                    let debit = 0;
                    let credit = 0;
                    
                    if (transaction.transactionType === 'receipt') {
                        credit = transaction.amount;
                        balance -= transaction.amount;
                    } else if (transaction.transactionType === 'payment') {
                        debit = transaction.amount;
                        balance += transaction.amount;
                    }
                    
                    ledgerEntries.push({
                        date: transaction.date,
                        description: transaction.description,
                        debit: debit,
                        credit: credit,
                        balance: balance
                    });
                }
                
                // بررسی معاملات مربوط به حساب‌های مرتبط
                let relatedAccount = '';
                if (transaction.transactionType === 'receipt') {
                    // دریافت: حساب انتخاب شده بستانکار می‌شود
                    let debitAccount = '';
                    
                    // تعیین حساب بدهکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            debitAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            debitAccount = 'حساب های دریافتنی';
                            break;
                        case 'check':
                            debitAccount = 'اسناد دریافتنی';
                            break;
                    }
                    
                    if (debitAccount === account.name) {
                        debit = transaction.amount;
                        credit = 0;
                        balance += transaction.amount;
                        
                        ledgerEntries.push({
                            date: transaction.date,
                            description: transaction.description,
                            debit: debit,
                            credit: credit,
                            balance: balance
                        });
                    }
                } else if (transaction.transactionType === 'payment') {
                    // پرداخت: حساب انتخاب شده بدهکار می‌شود
                    let creditAccount = '';
                    
                    // تعیین حساب بستانکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            creditAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            creditAccount = 'حساب های پرداختنی';
                            break;
                        case 'check':
                            creditAccount = 'اسناد پرداختنی';
                            break;
                    }
                    
                    if (creditAccount === account.name) {
                        debit = 0;
                        credit = transaction.amount;
                        balance -= transaction.amount;
                        
                        ledgerEntries.push({
                            date: transaction.date,
                            description: transaction.description,
                            debit: debit,
                            credit: credit,
                            balance: balance
                        });
                    }
                }
            });
            
            // مرتب‌سازی بر اساس تاریخ
            ledgerEntries.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            if (ledgerEntries.length === 0) {
                ledgerBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>هیچ معامله‌ای برای حساب "${account.name}" ثبت نشده است</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            ledgerEntries.forEach(entry => {
                html += `
                    <tr>
                        <td class="date-cell">${entry.date}</td>
                        <td class="description-cell">${entry.description}</td>
                        <td class="amount-cell">${entry.debit > 0 ? formatCurrency(entry.debit) : '-'}</td>
                        <td class="amount-cell">${entry.credit > 0 ? formatCurrency(entry.credit) : '-'}</td>
                        <td class="balance-cell">${formatCurrency(Math.abs(entry.balance))} ${entry.balance >= 0 ? 'بدهکار' : 'بستانکار'}</td>
                    </tr>
                `;
            });
            
            ledgerBody.innerHTML = html;
        }
        
        // تابع حذف حساب
        function deleteAccount(accountId) {
            if (confirm('آیا از حذف این حساب اطمینان دارید؟')) {
                // بررسی استفاده از حساب در معاملات
                let accountInUse = false;
                
                // بررسی در اسناد ذخیره شده
                savedDocuments.forEach(document => {
                    if (document.transactions.some(transaction => transaction.accountId == accountId)) {
                        accountInUse = true;
                    }
                });
                
                // بررسی در سند جاری
                if (currentDocumentTransactions.some(transaction => transaction.accountId == accountId)) {
                    accountInUse = true;
                }
                
                if (accountInUse) {
                    showNotification('این حساب در معاملات استفاده شده و قابل حذف نیست!', 'error');
                    return;
                }
                
                // حذف حساب از آرایه
                accounts = accounts.filter(account => account.id !== accountId);
                
                // حذف از IndexedDB
                deleteAccountFromDB(accountId);
                
                // به‌روزرسانی dropdown و لیست حساب‌ها
                updateAccountSelect();
                updateAccountsList();
                
                showNotification('حساب با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع حذف طرف حساب
        function deleteParty(partyId) {
            if (confirm('آیا از حذف این طرف حساب اطمینان دارید؟')) {
                // حذف طرف حساب از آرایه
                parties = parties.filter(party => party.id !== partyId);
                
                // حذف از IndexedDB
                deletePartyFromDB(partyId);
                
                // به‌روزرسانی dropdown و لیست طرف‌های حساب
                updatePartySelect();
                updatePartiesList();
                
                showNotification('طرف حساب با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع تولید سند حسابداری با منطق جدید
        function generateAccountingDocument() {
            let documentDate = new Date().toLocaleDateString('fa-IR');
            
            // محاسبه جمع مبالغ برای شرح
            let totalAmount = 0;
            let descriptionText = '';
            
            currentDocumentTransactions.forEach(transaction => {
                totalAmount += transaction.amount;
                
                // اضافه کردن طرف حساب به شرح
                let partyInfo = '';
                if (transaction.partyName) {
                    partyInfo = ` - طرف حساب: ${transaction.partyName}`;
                }
                
                descriptionText += `${transaction.description} (${getPaymentTypeText(transaction.paymentType)}${partyInfo}) - `;
            });
            
            // حذف آخرین خط تیره از شرح
            if (descriptionText.endsWith(' - ')) {
                descriptionText = descriptionText.slice(0, -3);
            }
            
            let html = `
                <div class="accounting-document">
                    <div class="document-header">
                        <div class="document-title">سند حسابداری</div>
                        <div class="document-date">تاریخ: ${documentDate}</div>
                    </div>
                    <table class="accounting-table">
                        <thead>
                            <tr>
                                <th>شرح حساب</th>
                                <th>بدهکار (ریال)</th>
                                <th>بستانکار (ریال)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentDocumentTransactions.forEach(transaction => {
                // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                
                if (transaction.transactionType === 'receipt') {
                    // دریافت: حساب انتخاب شده بستانکار می‌شود
                    let debitAccount = '';
                    
                    // تعیین حساب بدهکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            debitAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            debitAccount = 'حساب های دریافتنی';
                            break;
                        case 'check':
                            debitAccount = 'اسناد دریافتنی';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${debitAccount}</td>
                            <td class="debit">${formatCurrency(transaction.amount)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td>-</td>
                            <td class="credit">${formatCurrency(transaction.amount)}</td>
                        </tr>
                    `;
                } else if (transaction.transactionType === 'payment') {
                    // پرداخت: حساب انتخاب شده بدهکار می‌شود
                    let creditAccount = '';
                    
                    // تعیین حساب بستانکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            creditAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            creditAccount = 'حساب های پرداختنی';
                            break;
                        case 'check':
                            creditAccount = 'اسناد پرداختنی';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td class="debit">${formatCurrency(transaction.amount)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>${creditAccount}</td>
                            <td>-</td>
                            <td class="credit">${formatCurrency(transaction.amount)}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="document-description">
                        <div class="description-title">شرح سند:</div>
                        <div class="description-content">${descriptionText}</div>
                    </div>
                </div>
            `;
            
            documentPreview.innerHTML = html;
        }
        
        // تابع ذخیره سند
        function saveAccountingDocument() {
            const documentDate = new Date().toLocaleDateString('fa-IR');
            
            // محاسبه جمع مبلغ کل
            let totalAmount = 0;
            currentDocumentTransactions.forEach(transaction => {
                totalAmount += transaction.amount;
            });
            
            // ایجاد سند جدید
            const newDocument = {
                id: Date.now(),
                number: documentCounter++,
                date: documentDate,
                totalAmount: totalAmount,
                transactions: [...currentDocumentTransactions] // کپی از معاملات سند جاری
            };
            
            // افزودن به آرایه اسناد
            savedDocuments.push(newDocument);
            
            // ذخیره در IndexedDB
            saveDocument(newDocument);
            saveDocumentCounter();
            
            // پاک کردن سند جاری
            currentDocumentTransactions = [];
            saveCurrentDocument();
            
            // به‌روزرسانی لیست اسناد
            updateDocumentsList();
            
            // پاک کردن پیش‌نمایش
            documentPreview.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt"></i>
                    <p>پس از ثبت معامله، سند حسابداری در اینجا نمایش داده می‌شود</p>
                </div>
            `;
            
            // نمایش پیام موفقیت
            showNotification(`سند شماره ${toPersianNumbers(newDocument.number)} با موفقیت ذخیره شد!`, 'success');
        }
        
        // تابع مشاهده سند
        function viewDocument(documentId) {
            const document = savedDocuments.find(doc => doc.id === documentId);
            
            if (!document) {
                showNotification('سند مورد نظر یافت نشد!', 'error');
                return;
            }
            
            // ایجاد شرح از معاملات
            let descriptionText = '';
            document.transactions.forEach(transaction => {
                // اضافه کردن طرف حساب به شرح
                let partyInfo = '';
                if (transaction.partyName) {
                    partyInfo = ` - طرف حساب: ${transaction.partyName}`;
                }
                
                descriptionText += `${transaction.description} (${getPaymentTypeText(transaction.paymentType)}${partyInfo}) - `;
            });
            
            // حذف آخرین خط تیره از شرح
            if (descriptionText.endsWith(' - ')) {
                descriptionText = descriptionText.slice(0, -3);
            }
            
            // نمایش سند در پیش‌نمایش
            let html = `
                <div class="accounting-document">
                    <div class="document-header">
                        <div class="document-title">سند حسابداری شماره ${toPersianNumbers(document.number)}</div>
                        <div class="document-date">تاریخ: ${document.date}</div>
                    </div>
                    <table class="accounting-table">
                        <thead>
                            <tr>
                                <th>شرح حساب</th>
                                <th>بدهکار (ریال)</th>
                                <th>بستانکار (ریال)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            document.transactions.forEach(transaction => {
                // منطق جدید: حساب انتخاب شده در فرم برعکس نوع معامله و نوع پرداخت ثبت می‌شود
                
                if (transaction.transactionType === 'receipt') {
                    // دریافت: حساب انتخاب شده بستانکار می‌شود
                    let debitAccount = '';
                    
                    // تعیین حساب بدهکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            debitAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            debitAccount = 'حساب های دریافتنی';
                            break;
                        case 'check':
                            debitAccount = 'اسناد دریافتنی';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${debitAccount}</td>
                            <td class="debit">${formatCurrency(transaction.amount)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td>-</td>
                            <td class="credit">${formatCurrency(transaction.amount)}</td>
                        </tr>
                    `;
                } else if (transaction.transactionType === 'payment') {
                    // پرداخت: حساب انتخاب شده بدهکار می‌شود
                    let creditAccount = '';
                    
                    // تعیین حساب بستانکار بر اساس نوع پرداخت
                    switch(transaction.paymentType) {
                        case 'cash':
                            creditAccount = 'موجودی نقد';
                            break;
                        case 'credit':
                            creditAccount = 'حساب های پرداختنی';
                            break;
                        case 'check':
                            creditAccount = 'اسناد پرداختنی';
                            break;
                    }
                    
                    html += `
                        <tr>
                            <td>${transaction.accountName}</td>
                            <td class="debit">${formatCurrency(transaction.amount)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>${creditAccount}</td>
                            <td>-</td>
                            <td class="credit">${formatCurrency(transaction.amount)}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                    <div class="document-description">
                        <div class="description-title">شرح سند:</div>
                        <div class="description-content">${descriptionText}</div>
                    </div>
                </div>
            `;
            
            documentPreview.innerHTML = html;
        }
        
        // تابع حذف سند
        function deleteDocument(documentId) {
            if (confirm('آیا از حذف این سند اطمینان دارید؟')) {
                // حذف سند از آرایه
                savedDocuments = savedDocuments.filter(doc => doc.id !== documentId);
                
                // حذف از IndexedDB
                deleteDocumentFromDB(documentId);
                
                // به‌روزرسانی لیست اسناد
                updateDocumentsList();
                
                showNotification('سند با موفقیت حذف شد!', 'success');
            }
        }
        
        // تابع فرمت ارز به فارسی
        function formatCurrency(amount) {
            const formatted = amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return toPersianNumbers(formatted);
        }
        
        // تابع نمایش نوتیفیکیشن
        function showNotification(message, type) {
            // ایجاد المان نوتیفیکیشن
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                left: 30px;
                right: 30px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                font-weight: 600;
                font-size: 1rem;
            `;
            
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // حذف نوتیفیکیشن بعد از 3 ثانیه
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
    </script>
</body>
</html>
